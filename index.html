<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>OSINT Analyzer Ultimate (Rako)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/vis-network/styles/vis-network.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
body { font-family: Rubik, sans-serif; background:#121212; color:#fff; }
.container { max-width: 1400px; }
#resultMap { border:2px solid #333; height:700px; margin-top:20px; background:#1e1e1e; border-radius:12px; position:relative; }
#results { background:#222; padding:15px; border-radius:10px; max-height:300px; overflow:auto; color:#eee; font-size:14px; }
.tooltip-custom { position:absolute; background:rgba(0,0,0,0.9); color:#fff; padding:12px; border-radius:8px; max-width:350px; font-size:14px; display:none; z-index:1000; box-shadow:0 0 15px rgba(255,255,255,0.2);}
.result-card { background:#1e1e1e; padding:10px; margin-bottom:10px; border-radius:10px; display:flex; align-items:center; gap:10px; border:1px solid #444; }
.result-card img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
.result-card .info { flex:1; }
.result-card .info .title { font-weight:bold; color:#ffc107; }
.result-card .info .link { font-size:12px; color:#6cf; word-break:break-all; }
.result-card .info .type { font-size:12px; color:#fff; background:#444; padding:2px 6px; border-radius:4px; margin-top:4px; display:inline-block; }
.result-card button { background:#ff9800; border:none; color:#000; padding:6px 10px; border-radius:6px; cursor:pointer; }
.result-card button:hover { background:#ffc107; }
.spinner-inline { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.2); border-top-color:#ffc107; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-left:8px;}
@keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="text-center mb-3">�9�3 OSINT Analyzer Ultimate</h2>

    <form id="searchForm" class="p-3 bg-dark rounded mt-3">
        <div class="input-group mb-2">
            <input type="text" id="queryInput" class="form-control" placeholder="ابحث عن اسم او معرف..." required>
            <button class="btn btn-warning" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> بحث</button>
        </div>

        <div class="input-group">
            <label class="input-group-text" for="depthSelect">عمق البحث</label>
            <select id="depthSelect" class="form-select">
                <option value="1">1 مستوى</option>
                <option value="2" selected>2 مستويات</option>
                <option value="3">3 مستويات</option>
                <option value="5">5 مستويات</option>
            </select>
        </div>
    </form>

    <div id="resultMap"></div>

    <div class="mt-4 p-3 bg-dark rounded">
        <h4><i class="fa-solid fa-list"></i> نتائج البحث</h4>
        <div id="results"></div>
    </div>
</div>

<div id="tooltip" class="tooltip-custom" role="tooltip" aria-hidden="true"></div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
const tooltip = document.getElementById("tooltip");
const searchBtn = document.getElementById("searchBtn");
const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/565/565547.png";

document.getElementById("searchForm").onsubmit = async function(e){
    e.preventDefault();
    const queryInput = document.getElementById("queryInput");
    const depthSelect = document.getElementById("depthSelect");

    const query = queryInput.value.trim();
    if(!query) return;

    // UI: show loading indicator
    const spinner = document.createElement("span");
    spinner.className = "spinner-inline";
    searchBtn.disabled = true;
    searchBtn.appendChild(spinner);

    let form = new FormData();
    form.append("query", query);
    form.append("depth", depthSelect.value);

    try {
        const res = await fetch("/search", { method:"POST", body:form });
        if(!res.ok) throw new Error("Network response was not ok: " + res.status);
        const data = await res.json();
        renderResults(data);
        renderGraph(data, query);
    } catch (err) {
        console.error(err);
        document.getElementById("results").innerHTML = `<div class="text-danger">خطأ أثناء الطلب: ${escapeHtml(err.message)}</div>`;
        document.getElementById("resultMap").innerHTML = `<h3 class="text-center mt-5 text-danger">فشل في تحميل الخريطة</h3>`;
    } finally {
        searchBtn.disabled = false;
        if(spinner && spinner.parentNode) spinner.parentNode.removeChild(spinner);
    }
}

function renderResults(data){
    const container = document.getElementById("results");
    container.innerHTML = "";

    if(!Array.isArray(data) || data.length === 0){
        container.innerHTML = `<div class="text-muted">لا توجد نتائج.</div>`;
        return;
    }

    const types = {};
    data.forEach(result=>{
        if(!result || typeof result !== "object") return;
        const type = result.type && result.type.trim() !== "" ? result.type : "Websites";
        if(!types[type]) types[type]=[];
        types[type].push(result);
    });

    for(const type in types){
        types[type].forEach(result=>{
            const card = document.createElement("div");
            card.className = "result-card";

            const img = document.createElement("img");
            img.src = result.image || defaultAvatar;
            img.alt = result.title || type;

            const info = document.createElement("div");
            info.className = "info";
            const safeTitle = escapeHtml(result.title || type);
            const safeLink = escapeHtml(result.link || "");
            const safeType = escapeHtml(type);
            info.innerHTML = `
                <div class="title">${safeTitle}</div>
                <div class="link">${safeLink}</div>
                <div class="type">${safeType}</div>
            `;

            const btn = document.createElement("button");
            btn.textContent = "عرض";
            btn.onclick = ()=> alert(`العنوان: ${result.title || ""}\nالرابط: ${result.link || ""}\nالنوع: ${type}`);

            card.appendChild(img);
            card.appendChild(info);
            card.appendChild(btn);
            container.appendChild(card);
        });
    }
}

function renderGraph(data, queryName){
    const container = document.getElementById("resultMap");
    container.innerHTML = "";

    if(!Array.isArray(data) || data.length === 0){
        container.innerHTML = `<h3 class="text-center mt-5 text-danger">لا توجد بيانات لعرضها على الخريطة</h3>`;
        return;
    }

    // Normalize missing types
    data = data.map(r=>{
        if(!r || typeof r !== "object") return null;
        if(!r.type || r.type === "" || r.type === null) r.type = "Websites";
        return r;
    }).filter(Boolean);

    let nodes = [], edges = [], nid=2;

    nodes.push({
        id:1,
        label: queryName,
        shape:"box",
        color:"#ffc107",
        font:{color:"#000", size:18},
        title:"مصدر البحث"
    });

    const typeGroups = {};
    data.forEach(r=>{
        if(!typeGroups[r.type]) typeGroups[r.type] = [];
        typeGroups[r.type].push(r);
    });

    const icons = {
        "Twitter":["#1DA1F2","https://cdn-icons-png.flaticon.com/512/733/733579.png"],
        "Facebook":["#4267B2","https://cdn-icons-png.flaticon.com/512/733/733547.png"],
        "Instagram":["#E1306C","https://cdn-icons-png.flaticon.com/512/2111/2111463.png"],
        "YouTube":["#FF0000","https://cdn-icons-png.flaticon.com/512/1384/1384060.png"],
        "Telegram":["#0088cc","https://cdn-icons-png.flaticon.com/512/2111/2111646.png"],
        "LinkedIn":["#0077B5","https://cdn-icons-png.flaticon.com/512/174/174857.png"],
        "WhatsApp":["#25D366","https://cdn-icons-png.flaticon.com/512/733/733585.png"],
        "GitHub":["#333","https://cdn-icons-png.flaticon.com/512/733/733553.png"],
        "Reddit":["#FF4500","https://cdn-icons-png.flaticon.com/512/2111/2111581.png"],
        "Medium":["#00ab6c","https://cdn-icons-png.flaticon.com/512/2111/2111504.png"],
        "StackOverflow":["#f48024","https://cdn-icons-png.flaticon.com/512/2111/2111628.png"],
        "Pinterest":["#bd081c","https://cdn-icons-png.flaticon.com/512/2111/2111432.png"],
        "TikTok":["#69C9D0","https://cdn-icons-png.flaticon.com/512/3046/3046121.png"],
        "Websites":["#6cf","https://cdn-icons-png.flaticon.com/512/565/565547.png"],
        "Emails":["#FF9800","https://cdn-icons-png.flaticon.com/512/561/561127.png"],
        "Phone Numbers":["#4CAF50","https://cdn-icons-png.flaticon.com/512/15/15874.png"]
    };

    for(const type in typeGroups){
        let typeId = nid++;
        let [color, icon] = icons[type] || ["#6cf", defaultAvatar];

        nodes.push({
            id:typeId,
            label:type,
            shape:"image",
            image:icon,
            font:{color:"#fff"},
            title:`فئة: ${type}`
        });
        edges.push({from:1, to:typeId, arrows:{to:{enabled:true, scaleFactor:2}}, smooth:true, length:350});

        typeGroups[type].forEach(result=>{
            let id = nid++;
            nodes.push({
                id,
                label: result.title || result.link || type,
                shape:"image",
                image: result.image || icon,
                font:{color:"#fff"},
                title:`${result.title || ""}\n${result.link || ""}\nنوع: ${result.type || type}`
            });
            edges.push({from:typeId, to:id, arrows:{to:{enabled:true}}, dashes:true, smooth:{type: "cubicBezier"}, length:200});
        });
    }

    const dataSet = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
    const network = new vis.Network(container, dataSet, {
        physics:{
            enabled:true,
            barnesHut:{gravitationalConstant:-8000, centralGravity:0.3, springLength:300, springConstant:0.04, damping:0.09},
        },
        interaction:{hover:true, zoomView:true, dragView:true, tooltipDelay:100},
        nodes: { borderWidth:1 }
    });

    // Hover tooltip — robustly handle event shapes
    network.on("hoverNode", function(params){
        const node = network.body.data.nodes.get(params.node);
        if(!node) return;
        tooltip.innerHTML = escapeHtml(node.title || node.label || "");
        tooltip.style.display = "block";
        tooltip.setAttribute("aria-hidden", "false");

        const ev = (params.event && (params.event.srcEvent || params.event)) || window.event || {};
        const pageX = ev.pageX || (ev.touches && ev.touches[0] && ev.touches[0].pageX) || 0;
        const pageY = ev.pageY || (ev.touches && ev.touches[0] && ev.touches[0].pageY) || 0;

        const margin = 12;
        let left = pageX + 10;
        let top = pageY + 10;
        // delay layout read to ensure offsetWidth/Height available
        requestAnimationFrame(()=>{
            const maxLeft = window.innerWidth - tooltip.offsetWidth - margin;
            const maxTop = window.innerHeight - tooltip.offsetHeight - margin;
            if(left > maxLeft) left = maxLeft;
            if(top > maxTop) top = maxTop;
            tooltip.style.left = left + "px";
            tooltip.style.top  = top + "px";
        });
    });
    network.on("blurNode",()=> {
        tooltip.style.display = "none";
        tooltip.setAttribute("aria-hidden", "true");
    });

    // click to open link if present in title
    network.on("click", function(params){
        if(params.nodes && params.nodes.length){
            const node = network.body.data.nodes.get(params.nodes[0]);
            if(node && node.title){
                const parts = (node.title + "").split(/\n/).map(s => s.trim()).filter(Boolean);
                const maybeLink = parts.find(p => p.startsWith("http://") || p.startsWith("https://"));
                if(maybeLink) window.open(maybeLink, "_blank");
            }
        }
    });
}

// small helper: escape HTML in inserted strings
function escapeHtml(s){
    return String(s || "").replace(/[&<>"'`=\/]/g, function(ch) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#47;',
            '`': '&#96;',
            '=': '&#61;'
        })[ch];
    });
}
</script>
</body>
</html>
